<!DOCTYPE html>
<html>
<head>
    <title>Mobile Minecraft</title>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
            touch-action: none; 
            background-color: #87CEEB;
            font-family: Arial, sans-serif;
        }
        canvas { 
            display: block; 
            width: 100vw; 
            height: 100vh; 
        }
        #joystick {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 100px;
            height: 100px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            touch-action: none;
        }
        #joystickKnob {
            position: absolute;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            top: 30px;
            left: 30px;
        }
        #inventory {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 5px;
        }
        .inventory-slot {
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #8B8B8B;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 12px;
        }
        .inventory-slot.active {
            border-color: white;
        }
    </style>
</head>
<body>
    <canvas id="game"></canvas>
    <div id="joystick"><div id="joystickKnob"></div></div>
    <div id="inventory">
        <div class="inventory-slot active">D (99)</div>
        <div class="inventory-slot">G (99)</div>
        <div class="inventory-slot">S (99)</div>
        <div class="inventory-slot">W (99)</div>
        <div class="inventory-slot">Sd (99)</div>
    </div>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // Game settings
        const BLOCK_SIZE = 40;
        const WORLD_WIDTH = 20;
        const WORLD_HEIGHT = 10;
        const GRAVITY = 0.5;
        const JUMP_FORCE = -10;
        const PLAYER_SPEED = 3;

        // Block types
        const BLOCKS = {
            AIR: 0,
            DIRT: 1,
            GRASS: 2,
            STONE: 3,
            WOOD: 4,
            SAND: 5
        };

        // Player
        const player = {
            x: 100,
            y: 100,
            width: BLOCK_SIZE * 0.8,
            height: BLOCK_SIZE * 1.5,
            velX: 0,
            velY: 0,
            isJumping: false,
            selectedBlock: BLOCKS.DIRT
        };

        // Inventory
        const inventory = {
            [BLOCKS.DIRT]: { name: "Dirt", count: 99 },
            [BLOCKS.GRASS]: { name: "Grass", count: 99 },
            [BLOCKS.STONE]: { name: "Stone", count: 99 },
            [BLOCKS.WOOD]: { name: "Wood", count: 99 },
            [BLOCKS.SAND]: { name: "Sand", count: 99 }
        };

        // World
        const world = Array(WORLD_WIDTH).fill().map(() => Array(WORLD_HEIGHT).fill(BLOCKS.AIR));
        
        // Generate ground
        for (let x = 0; x < WORLD_WIDTH; x++) {
            for (let y = WORLD_HEIGHT - 3; y < WORLD_HEIGHT; y++) {
                world[x][y] = y === WORLD_HEIGHT - 3 ? BLOCKS.GRASS : BLOCKS.DIRT;
            }
        }

        // Joystick setup
        const joystick = document.getElementById('joystick');
        const joystickKnob = document.getElementById('joystickKnob');
        let joystickActive = false;
        let joystickStartX = 0;
        let joystickStartY = 0;
        let joystickX = 0;
        let joystickY = 0;

        joystick.addEventListener('touchstart', (e) => {
            joystickActive = true;
            const rect = joystick.getBoundingClientRect();
            joystickStartX = rect.left + rect.width / 2;
            joystickStartY = rect.top + rect.height / 2;
            updateJoystick(e.touches[0].clientX, e.touches[0].clientY);
            e.preventDefault();
        });

        document.addEventListener('touchmove', (e) => {
            if (joystickActive) {
                updateJoystick(e.touches[0].clientX, e.touches[0].clientY);
                e.preventDefault();
            }
        });

        document.addEventListener('touchend', () => {
            joystickActive = false;
            joystickX = 0;
            joystickY = 0;
            joystickKnob.style.transform = 'translate(30px, 30px)';
        });

        function updateJoystick(touchX, touchY) {
            const dx = touchX - joystickStartX;
            const dy = touchY - joystickStartY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const maxDistance = 30;
            const deadZone = 5;

            if (distance > deadZone) {
                if (distance > maxDistance) {
                    const angle = Math.atan2(dy, dx);
                    joystickX = Math.cos(angle) * maxDistance;
                    joystickY = Math.sin(angle) * maxDistance;
                } else {
                    joystickX = dx;
                    joystickY = dy;
                }
            } else {
                joystickX = joystickY = 0;
            }

            joystickKnob.style.transform = `translate(${joystickX + 30}px, ${joystickY + 30}px)`;
        }

        // Inventory selection
        const inventorySlots = document.querySelectorAll('.inventory-slot');
        inventorySlots.forEach((slot, index) => {
            slot.addEventListener('click', () => {
                inventorySlots.forEach(s => s.classList.remove('active'));
                slot.classList.add('active');
                player.selectedBlock = Object.keys(BLOCKS)[index + 1];
            });
        });

        // Block breaking/placing
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            const blockX = Math.floor(mouseX / BLOCK_SIZE);
            const blockY = Math.floor(mouseY / BLOCK_SIZE);

            // Prevent placing inside player
            const playerBlockX = Math.floor(player.x / BLOCK_SIZE);
            const playerBlockY = Math.floor(player.y / BLOCK_SIZE);
            if (Math.abs(blockX - playerBlockX) < 2 && Math.abs(blockY - playerBlockY) < 2) return;

            if (blockX >= 0 && blockX < WORLD_WIDTH && blockY >= 0 && blockY < WORLD_HEIGHT) {
                if (world[blockX][blockY] === BLOCKS.AIR) {
                    // Place block if available in inventory
                    if (inventory[player.selectedBlock].count > 0) {
                        world[blockX][blockY] = player.selectedBlock;
                        inventory[player.selectedBlock].count--;
                        updateInventoryDisplay();
                    }
                } else {
                    // Break block and add to inventory
                    const brokenBlock = world[blockX][blockY];
                    inventory[brokenBlock].count++;
                    world[blockX][blockY] = BLOCKS.AIR;
                    updateInventoryDisplay();
                }
            }
        });

        function updateInventoryDisplay() {
            inventorySlots.forEach((slot, index) => {
                const blockType = Object.keys(BLOCKS)[index + 1];
                slot.textContent = `${inventory[blockType].name[0]} (${inventory[blockType].count})`;
            });
        }

        // Optimized collision detection
        function checkCollision(x, y) {
            const blockXStart = Math.floor(x / BLOCK_SIZE);
            const blockXEnd = Math.floor((x + player.width) / BLOCK_SIZE);
            const blockYStart = Math.floor(y / BLOCK_SIZE);
            const blockYEnd = Math.floor((y + player.height) / BLOCK_SIZE);

            for (let bx = blockXStart; bx <= blockXEnd; bx++) {
                for (let by = blockYStart; by <= blockYEnd; by++) {
                    if (bx >= 0 && bx < WORLD_WIDTH && by >= 0 && by < WORLD_HEIGHT && world[bx][by] !== BLOCKS.AIR) {
                        return true;
                    }
                }
            }
            return false;
        }

        // Draw functions
        function drawWorld() {
            for (let x = 0; x < WORLD_WIDTH; x++) {
                for (let y = 0; y < WORLD_HEIGHT; y++) {
                    if (world[x][y] !== BLOCKS.AIR) {
                        // Block textures
                        switch (world[x][y]) {
                            case BLOCKS.DIRT:
                                const dirtGradient = ctx.createLinearGradient(
                                    x * BLOCK_SIZE, y * BLOCK_SIZE, 
                                    x * BLOCK_SIZE + BLOCK_SIZE, y * BLOCK_SIZE + BLOCK_SIZE
                                );
                                dirtGradient.addColorStop(0, '#5C4033');
                                dirtGradient.addColorStop(1, '#8B4513');
                                ctx.fillStyle = dirtGradient;
                                break;
                            case BLOCKS.GRASS:
                                const grassGradient = ctx.createLinearGradient(
                                    x * BLOCK_SIZE, y * BLOCK_SIZE, 
                                    x * BLOCK_SIZE, y * BLOCK_SIZE + BLOCK_SIZ
