<!DOCTYPE html>
<html style="width:100%;height:100%;background-color:black;">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <meta name="description" content="HZ OneBlock Client Ultra FPS" />
  <meta name="keywords" content="eaglercraft, minecraft, oneblock, 1.8, spigot, fps" />
  <title>HZ OneBlock Adaptive Ultra FPS</title>
  <link type="image/png" rel="shortcut icon" href="favicon.png" />

  <!-- Define opts BEFORE classes.js -->
  <script>
    "use strict";
    window.eaglercraftXOpts = {
      demoMode: false,
      container: "game_frame",
      assetsURI: "assets.epk",
      localesURI: "lang/",
      worldsDB: "worlds",
      logInvalidCerts: false,
      crashOnUncaughtExceptions: false,
      maxParticles: 50,
      disableInstancedRendering: true,
      smoothGui: false,
      renderScale: 0.5,
      servers: [
        { addr: "ws://localhost:8081/", name: "Local OneBlock Server" }
      ],
      relays: [
        { addr: "wss://relay.deev.is/", comment: "relay #1", primary: true },
        { addr: "wss://relay.lax1dude.net/", comment: "relay #2" },
        { addr: "wss://relay.shhnowisnottheti.me/", comment: "relay #3" }
      ]
    };
  </script>

  <!-- Load engine -->
  <script type="text/javascript" src="classes.js"></script>
</head>
<body style="margin:0;width:100%;height:100%;overflow:hidden;background-color:black;" id="game_frame">
  <script>
    "use strict";

    window.addEventListener("load", function() {
      if (typeof main === "function") {
        main();
        console.log("✅ Game started with Adaptive Ultra FPS");
      } else {
        alert("ERROR: main() not found in classes.js");
      }
    });

    /* Adaptive Ultra FPS (soft cap 240 for older devices) */
    (function ultraFPS() {
      const LOG = (...a) => console.log("[ultraFPS]", ...a);

      function poll(fn, cb, i = 200) {
        const t = setInterval(() => {
          try { if (fn()) { clearInterval(t); cb(); } } catch {}
        }, i);
      }

      // Detect performance level
      function detectPerformance(callback) {
        const start = performance.now();
        let count = 0;
        function test() {
          count++;
          if (performance.now() - start < 100) {
            requestAnimationFrame(test);
          } else {
            const fpsEstimate = count * 10; // rough estimate in 100ms
            let maxFPS;
            if (fpsEstimate > 1000) maxFPS = 0;   // uncapped
            else maxFPS = 240;                     // soft cap for older devices
            callback(maxFPS);
          }
        }
        test();
      }

      // Adaptive FPS loop
      function patchLoop(maxFPS = 0) {
        if (!window.EaglercraftX || !window.EaglercraftX.mainLoop) return;
        if (window._ultraFPS_loop) return;

        const oldLoop = window.EaglercraftX.mainLoop.bind(window.EaglercraftX);
        function loop() {
          try { oldLoop(); } catch (e) {}
          if (maxFPS > 0) setTimeout(loop, 1000 / maxFPS);
          else setTimeout(loop, 0); // uncapped
        }
        window.EaglercraftX.mainLoop = loop;
        window._ultraFPS_loop = true;
        LOG(maxFPS > 0 ? `Main loop capped at ${maxFPS} FPS for smoother performance` : "Main loop running uncapped (turbo mode)");
      }

      // Optimize graphics for performance
      function patchGraphics() {
        if (!window.EaglercraftX || !window.EaglercraftX.settings) return;
        if (window._ultraFPS_gfx) return;
        let s = window.EaglercraftX.settings;

        s.useFXAA = false;
        s.dynamicLights = false;
        s.renderDistance = 2;
        s.smoothLighting = false;
        s.clouds = false;
        s.particles = "minimal";
        s.graphics = "fast";
        s.entityShadows = false;
        s.mipmapLevels = 0;
        s.ao = false;

        window._ultraFPS_gfx = true;
        LOG("Graphics set to minimum for max performance");
      }

      // Async chunk builder
      function patchChunkBuilder() {
        if (!window.EaglercraftX || !window.EaglercraftX.chunkBuilder) return;
        if (window._ultraFPS_chunk) return;
        const cb = window.EaglercraftX.chunkBuilder;
        if (typeof cb.buildNext !== "function") return;
        const old = cb.buildNext.bind(cb);
        cb.buildNext = function() { setTimeout(() => old(), 1); };
        window._ultraFPS_chunk = true;
        LOG("Chunk builder patched for lazy async loading");
      }

      // Apply patches once game is loaded
      poll(() => window.EaglercraftX && typeof main === "function", () => {
        LOG("⚡ Applying Adaptive Ultra FPS patches...");
        patchGraphics();
        patchChunkBuilder();
        detectPerformance(patchLoop);
      });
    })();
  </script>
</body>
</html>
